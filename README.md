# 一、APP界面及功能展示：

## 1.登录界面:

![1](https://github.com/1170159634/Crabshell/blob/master/images/11.jpg)

<img src="https://github.com/1170159634/Crabshell/blob/master/images/11.jpg" width = "500" height = "700"  />

## 2.学生端-数据监测画面:

![1](https://github.com/1170159634/Crabshell/blob/master/images/12.jpg)

## 3.学生端-接受管理员发送的安全日志：

![1](https://github.com/1170159634/Crabshell/blob/master/images/13.jpg)

## 4.学生端-控制宿舍各个开关:

![1](https://github.com/1170159634/Crabshell/blob/master/images/14.jpg)

## 5.学生端-查看某个安全日志:

![1](https://github.com/1170159634/Crabshell/blob/master/images/15.jpg)

## 6.管理员-实时监测所有宿舍：

![1](https://github.com/1170159634/Crabshell/blob/master/images/16.jpg)

## 7.管理员-发送安全日志：

![1](https://github.com/1170159634/Crabshell/blob/master/images/17.jpg)



## 8.管理员-管理所有安全日志：

![1](https://github.com/1170159634/Crabshell/blob/master/images/18.jpg)

# 二、功能实现及流程图：

## 1.火灾报警器

当温度，湿度，烟雾浓度同时到达一定的阈值时进行短信提醒宿舍人员与管理员，你可以实时监测宿舍温度，湿度，烟雾浓度来判断宿舍的环境是否安全。一旦发生险情，通过蜂鸣器与短信提醒宿舍学生及管理员，使人们及早得知火情，将火灾扑灭在萌芽状态。

## 2.天气恶劣提示

当雷雨天气时，app自动提醒关闭门窗，防止雷电直击室内和球形雷飘进室内，关闭电源，以免雷电伤人及损坏电器。大雨和雷电交加时，应该慎用有线和无线电话，雷雨天气，手机开机状态下，特别是在接打电话时，电磁波信号较强，容易引发“感应雷”。通过温馨提示，既可以避免雷电所带来的危害，又可以使学生增强安全意识。

## 3.管理信息发布（本人开发）

为达到管理员与学生宿舍更好的交流，管理员可以在app上发表注意事项与特殊情况，学生端只能查看信息，分为普通信息和紧急信息两种，一旦是紧急信息，手机系统会自动弹窗，对本人进行提示，如果手机后台未打开该程序，则发送紧急短信，提示所在宿舍已发生的问题，并提供管理员电话，如果是普通信息，则相应的APP对其提示即可。可使楼管对宿舍更好的管理。

## 4.  一键控制（本人开发）

过来人都知道，在学生宿舍，睡在下铺的兄弟，上辈子一定是折翼的天使，除了日常动不动的“下铺帮忙倒杯水”，再到“下铺快去开个门”，尤其是冬天每天晚上最最不能忍的就是“下铺快去关灯”，或者晚上自动断电忘关灯时宿舍灯火通明，使人无法继续安睡，本着关爱睡觉，爱护下铺的原则，实现了这个功能，在床上即可操作灯，风扇，空调等的开关，彻底解放下铺，使宿舍管理简洁方便。

## （1）学生登录APP：

![123](https://github.com/1170159634/Crabshell/blob/master/images/1.png)



## （2）管理员登录APP：

![1234](https://github.com/1170159634/Crabshell/blob/master/images/2.png)

## （3）学生远程控制本宿舍灯开关图：

![12345](https://github.com/1170159634/Crabshell/blob/master/images/3.png)

## （4）火灾预警发送紧急短信流程图：

![123456](https://github.com/1170159634/Crabshell/blob/master/images/4.png)

## （5）管理员发表安全日志:

![123456789](https://github.com/1170159634/Crabshell/blob/master/images/5.png)

# 三、接口路径：

## 1.公共功能：

### **（1）登录授权**

| 接口地址 | **/** user/login?number=用户名&password=密码 |              |      |
| -------- | -------------------------------------------- | ------------ | ---- |
| 说明     | 根据用户名和密码进行授权登录                 |              |      |
| 请求方式 | Get                                          | 返回数据类型 | Json |



### **（2）获取房间的状态**

| 接口地址 | /room/status                                                 |              |      |
| -------- | ------------------------------------------------------------ | ------------ | ---- |
| 说明     | 实时获取用户获取房间湿度，温度，浓度，宿舍灯的状态，门的状态，水位，水滴 |              |      |
| 请求方式 | Get                                                          | 返回数据类型 | Json |

### **（3）获取房间信息**

| 接口地址 | / **user/room**                                          |              |      |
| -------- | -------------------------------------------------------- | ------------ | ---- |
| 说明     | 管理员获取**所有宿舍信息**，而普通学生获取**本宿舍信息** |              |      |
| 请求方式 | Post                                                     | 返回数据类型 | Json |

### **（4）获取管理员发表的信息**

| 接口地址 | /questions                       |              |      |
| -------- | -------------------------------- | ------------ | ---- |
| 说明     | 获取管理员发表的所有**安全信息** |              |      |
| 请求方式 | Get                              | 返回数据类型 | Json |

### **（5）获取个人信息**

| 接口地址 | /user/message?userNumber=用户编号 |              |      |
| -------- | --------------------------------- | ------------ | ---- |
| 说明     | **点击头像后获取的**              |              |      |
| 请求方式 | Get                               | 返回数据类型 | Json |

## 2.管理员功能：

### **（1）发表安全日志（每日安全注意事项）**

 

| 接口地址 | /publish                                 |              |      |
| -------- | ---------------------------------------- | ------------ | ---- |
| 说明     | 发表安全信息，其中分为普通信息和紧急信息 |              |      |
| 请求方式 | Post                                     | 返回数据类型 |      |

### **（2）接收所有宿舍发生过的异常信息**

 

| 接口地址 | **/getAllError**                 |              |      |
| -------- | -------------------------------- | ------------ | ---- |
| 说明     | 所有宿舍发生过的安全异常进行接收 |              |      |
| 请求方式 | GET                              | 返回数据类型 | Json |

### **（3）接收某个宿舍发生过的异常信息**

 

| 接口地址 | /getOneRoomError?room=房间编号 |              |      |
| -------- | ------------------------------ | ------------ | ---- |
| 说明     | 获取该宿舍发生过的异常问题     |              |      |
| 请求方式 | GET                            | 返回数据类型 | Json |

### （4）接收所有宿舍发生过的异常信息总数

 

| 接口地址 | /getUnsafeCount              |              |      |
| -------- | ---------------------------- | ------------ | ---- |
| 说明     | 获取所有宿舍发生过的问题总数 |              |      |
| 请求方式 | GET                          | 返回数据类型 | Json |

## 3.学生使用功能：

### **（1）查询自己宿舍灯是否打开**

 

| 接口地址 | /light/宿舍编号      |              |      |
| -------- | -------------------- | ------------ | ---- |
| 说明     | 查询自己宿舍是否打开 |              |      |
| 请求方式 | Get                  | 返回数据类型 | Json |

### **（2）修改自己宿舍灯的亮灭**

| 接口地址 | /updatelight/宿舍编号/状态 |              |      |
| -------- | -------------------------- | ------------ | ---- |
| 说明     | 查询自己宿舍是否打开       |              |      |
| 请求方式 | Get                        | 返回数据类型 | Json |

4.接受安全日志：

### （1）  **查询自己是否有未读消息**

 

| 接口地址 | /unReadCount?receiver=用户编号           |              |      |
| -------- | ---------------------------------------- | ------------ | ---- |
| 说明     | 查询自己没有读取管理员的**未读消息总数** |              |      |
| 请求方式 | Get                                      | 返回数据类型 | Json |

### （2）  **在主界面标题栏获取未读和已读消息内容**

 

| 接口地址 | /unReadTextTitle?receiver=用户编号                   |              |      |
| -------- | ---------------------------------------------------- | ------------ | ---- |
| 说明     | 进入到主界面，会发现有**未读消息**和**已读消息内容** |              |      |
| 请求方式 | Get                                                  | 返回数据类型 | Json |

### （3）  **获取单个消息的具体内容**

 

| 接口地址 | /unReadText?notifier=问题编号            |              |      |
| -------- | ---------------------------------------- | ------------ | ---- |
| 说明     | **点击标题栏后，进入到单个页面展示消息** |              |      |
| 请求方式 | Get                                      | 返回数据类型 | Json |

###  （4）**标记消息为已读**

 

| 接口地址 | /updateRead?receiver=当前用户编号（int类型）&number=状态编号 |              |      |
| -------- | ------------------------------------------------------------ | ------------ | ---- |
| 说明     | **未读消息在点击进入到消息页面，执行该请求，未读消息-1**     |              |      |
| 请求方式 | Get                                                          | 返回数据类型 | Json |



# 四、实现难点：

## 1、硬件获取控制类数据，令人最头疼的延迟问题

 我们起初的目的是为了让硬件的数据通过获取HTTP请求，得到数据库中的数据并进行一系列安全预测及控制操作。

### 1）为什么选择利用HTTP请求解决控制问题?

 因为我们的想法是摆脱内网，真正的实现无论何时何地，只要有手机就可以控制自己宿舍的各个开关，实时观察到宿舍安全情况，而不是通过只有在宿舍才能操作。

### 2）一旦数据有延迟，该如何处理？

 起初，我们选择硬件直接HTTP请求获取，发现有将近5、6秒的延迟。这完全不符合我们的初衷，所以我们打算在服务器里搭建MQTT服务器，让硬件直接获取MQTT服务器发来的数据。发现利用MQTT发送数据，让硬件进行控制，0延迟。

### 3）我们该如何将物联网流行协议MQTT与HTTP协议搭配起来用？

当用户想要控制时，服务器端手动向硬件发送MQTT协议数据，易用性太差，我们直接利用Python语言编写脚本，让服务器实现：获取HTTP请求数据-> 处理Json数据，并规范发送格式 -> 通过MQTT服务器发送。

这样，在用户想要在APP端控制时，服务器端自动检测到数据库数据发生改变，然后通过MQTT服务器发送到硬件设备，完成控制。

### 4）为什么使用MQTT协议+HTTP协议而不使用最常用的TCP协议解决问题？

MQTT基于异步发布/订阅的实现解耦了消息发布者和订阅者，基于二进制的实现节省了存储空间及流量，同时MQTT拥有更好的消息处理机制，可以替代TCP Socket一部分应用场景。相对于HTTP和XMPP，MQTT可以选择用户数据格式，解析复杂度低，同时MQTT也可用于手机推送等领域。

特别适合于网络代价昂贵，带宽低、不可靠的环境。 

能在处理器和内存资源有限的嵌入式设备中运行。 使用发布订阅消息模式，提供一对多的消息发布，从而解除应用程序耦合。



## 2、如何解决并发流量下，数据流转的问题？

由于该应用针对人群为宿舍管理员和学生，很多情况下会导致突发请求访问关系型数据库，此时虽然是读多写少的模式，但写入量已经大大提升。很多学生访问服务器关系型数据库，必然会导致关系型数据库的读写操作大大提升。此时关系型数据库的读写性能较差。

### 为什么关系型数据库在高数据量的情况下会出现性能较差这样的问题？

关系型数据库遵循ACID规则（原子性(Atomicity)、一致性(Consistency)、隔离性(Isolation)、持久性(Durability)），而Nosql数据库遵循BASE原则（基本可用（Basically Availble）、软/柔性事务（Soft-state ）、最终一致性（Eventual Consistency））。由于关系型数据库的数据强一致性，所以对事务的支持很好。关系型数据库支持对事务原子性细粒度控制，并且易于回滚事务。而Nosql数据库是在CAP（一致性、可用性、分区容忍度）中任选两项，因为基于节点的分布式系统中，很难全部满足。关系型数据库为了维护数据的一致性付出了巨大的代价，读写性能比较差。在面对高并发读写性能非常差，面对海量数据的时候效率非常低。

### 我们该如何解决用户请求访问数据量高，且性能较差的问题？

我们在做后台开发时，考虑到有可能学生同时访问量不止100~200个，有可能是2000~3000个学生同时进行访问，并且我们是一款面向学生安全的APP，如在管理员发表安全信息时，有时会有紧急信息，需要实时传递到学生手机上，此时做后台请求一定要考虑性能方面的问题，所以，我们在后台请求这里引入了非关系型数据库（Nosql）。